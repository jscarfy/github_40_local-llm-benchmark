name: Release Workflow

on:
  push:
    tags:
      - 'v*'  # Trigger this workflow on version tag push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: '1.16'  # Use the appropriate Go version

    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod tidy

    - name: Run tests
      run: go test ./...

    - name: Build the project
      run: go build -o dist/srh ./cmd/srh

    - name: Create GitHub release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git tag -a "v${GITHUB_REF##*/}" -m "Release version ${GITHUB_REF##*/}"
        git push origin "v${GITHUB_REF##*/}"
        curl -XPOST -H "Authorization: token $GITHUB_TOKEN" \
          -d "{\"tag_name\": \"v${GITHUB_REF##*/}\", \"name\": \"Release v${GITHUB_REF##*/}\", \"body\": \"Release ${GITHUB_REF##*/} contains the latest changes.\"}" \
          "https://api.github.com/repos/${{ github.repository }}/releases"
