#!/usr/bin/env bash
set -euo pipefail

say(){ printf "\n\033[1m%s\033[0m\n" "$*"; }
need(){ command -v "$1" >/dev/null 2>&1 || { echo "Missing required command: $1" >&2; exit 2; }; }

need git
need sed
need awk
need perl

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "$ROOT" ]]; then
  d="$PWD"
  while [[ "$d" != "/" ]]; do
    if [[ -d "$d/.git" ]]; then ROOT="$d"; break; fi
    d="$(cd "$d/.." && pwd)"
  done
fi
[[ -n "$ROOT" ]] || { echo "ERROR: cannot find repo root"; exit 2; }
cd "$ROOT"

say "Project root: $ROOT"
mkdir -p scripts sections amsart beamer build

# ---- scripts/find_root.sh ----
cat > scripts/find_root.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
if git rev-parse --show-toplevel >/dev/null 2>&1; then
  git rev-parse --show-toplevel
  exit 0
fi
d="$PWD"
while [[ "$d" != "/" ]]; do
  if [[ -d "$d/.git" ]]; then echo "$d"; exit 0; fi
  d="$(cd "$d/.." && pwd)"
done
exit 1
EOF
chmod +x scripts/find_root.sh

# ---- scripts/add_section.sh ----
cat > scripts/add_section.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
ROOT="$(bash "$(dirname "${BASH_SOURCE[0]}")/find_root.sh")"
cd "$ROOT"

num="${1:-}"
slug="${2:-}"
title="${3:-}"

[[ -n "$num" && -n "$slug" && -n "$title" ]] || {
  echo "Usage: bash scripts/add_section.sh <NUM> <SLUG> <TITLE>" >&2
  exit 2
}

file="sections/${num}_${slug}.tex"
if [[ -f "$file" ]]; then
  echo "[SKIP] exists: $file"
  exit 0
fi

cat > "$file" <<TEX
% ============================================================
% Section ${num}: ${title}
% Auto-generated skeleton. Expand freely.
% ============================================================

\\section{${title}}
\\label{sec:${num}_${slug}}

\\subsection{Motivation}
We develop a rigorous formalism for entropy-driven structures in the project’s trace/bifurcation language.

\\subsection{Definitions}

\\begin{definition}[Entropy datum]
An \\emph{entropy datum} is a triple \\(\\mathsf{M}=(\\mathcal{T},\\mathcal{H},\\mathcal{F})\\) where
\\(\\mathcal{T}\\) is a trace-bearing object, \\(\\mathcal{H}\\) an entropy functional, and \\(\\mathcal{F}\\) a flow operator package.
\\end{definition}

\\begin{definition}[Discrepancy]
For \\(\\mathsf{M},\\mathsf{M}'\\) define
\\[
  \\Delta_{\\mathrm{ent}}(\\mathsf{M},\\mathsf{M}'):=\\sup |\\mathcal{H}-\\mathcal{H}'|.
\\]
\\end{definition}

\\subsection{Stability}

\\begin{theorem}[Coarse stability]
If \\(\\Delta_{\\mathrm{ent}}(\\mathsf{M},\\mathsf{M}')\\le \\delta\\), then the induced stratifications differ by at most \\(C\\delta\\)
in the project’s chosen trace/flow metric.
\\end{theorem}

\\begin{proof}
Skeleton: Lipschitz control of the stratification functor + discrepancy bound.
\\end{proof}

\\subsection{Next inserts}
Add: (i) explicit bracket--trace compatibility; (ii) bifurcation wall examples; (iii) operator-algebraic estimates.
TEX

echo "[OK] created: $file"
EOF
chmod +x scripts/add_section.sh

# ---- scripts/sync_inputs.sh ----
cat > scripts/sync_inputs.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
ROOT="$(bash "$(dirname "${BASH_SOURCE[0]}")/find_root.sh")"
cd "$ROOT"

mkdir -p amsart beamer

list_sections() {
  ls -1 sections/*.tex 2>/dev/null | perl -ne '
    if (/sections\/(\d+)_([^\/]+)\.tex/) { print "$1\t$ARGV\n"; }
  ' | sort -n | awk -F'\t' '{print $2}'
}

outA="amsart/sections_auto.tex"
{
  echo "% Auto-generated. Do not hand edit."
  echo "% Generated by scripts/sync_inputs.sh"
  echo ""
  while IFS= read -r f; do
    echo "\\input{../$f}"
  done < <(list_sections)
} > "$outA"

outB="beamer/sections_auto.tex"
{
  echo "% Auto-generated. Do not hand edit."
  echo "% Generated by scripts/sync_inputs.sh"
  echo ""
  while IFS= read -r f; do
    echo "% ---- $f ----"
    echo "\\input{../$f}"
    echo ""
  done < <(list_sections)
} > "$outB"

echo "[OK] wrote: $outA"
echo "[OK] wrote: $outB"
EOF
chmod +x scripts/sync_inputs.sh

# ---- ensure minimal amsart/main.tex exists ----
if [[ ! -f amsart/main.tex ]]; then
  cat > amsart/main.tex <<'EOF'
\documentclass{amsart}
\usepackage{amsmath,amssymb,amsthm}
\title{Entropy Cohomology, Zeta Flow, and the Arithmetic Geometry of $\mathbb{Y}_n(F)$}
\author{Pu Justin Yang}
\date{\today}
\begin{document}
\maketitle
\tableofcontents

\input{sections_auto.tex}

\end{document}
EOF
fi

# ---- ensure minimal beamer/slides.tex exists ----
if [[ ! -f beamer/slides.tex ]]; then
  cat > beamer/slides.tex <<'EOF'
\documentclass{beamer}
\usetheme{Madrid}
\title{Entropy Cohomology \& Zeta Flow}
\author{Pu Justin Yang}
\date{\today}
\begin{document}
\frame{\titlepage}

\input{sections_auto.tex}

\end{document}
EOF
fi

# ---- patch includes if missing ----
if ! grep -q 'sections_auto\.tex' amsart/main.tex; then
  perl -0777 -i -pe 's/\\tableofcontents\s*/\\tableofcontents\n\n\\input{sections_auto.tex}\n\n/s' amsart/main.tex
fi
if ! grep -q 'sections_auto\.tex' beamer/slides.tex; then
  perl -0777 -i -pe 's/\\begin\{document\}\s*/\\begin{document}\n\n\\input{sections_auto.tex}\n\n/s' beamer/slides.tex
fi

# ---- generate next block of sections ----
say "Generating sections 225–240 (idempotent)..."
bash scripts/add_section.sh 225 entropy_motives_theory "Entropy Motives Theory"
bash scripts/add_section.sh 226 high_dimensional_entropy_analysis "High-Dimensional Entropy Analysis"
bash scripts/add_section.sh 227 bifurcation_impact_theory "Bifurcation Impact Theory"
bash scripts/add_section.sh 228 entropy_trace_kernels "Entropy Trace Kernels"
bash scripts/add_section.sh 229 wall_crossing_entropy_functors "Wall-Crossing Entropy Functors"
bash scripts/add_section.sh 230 entropy_operator_algebras "Entropy Operator Algebras"
bash scripts/add_section.sh 231 entropy_period_regulators "Entropy Period Regulators"
bash scripts/add_section.sh 232 flow_langlands_entropy_group "Flow–Langlands Entropy Group"
bash scripts/add_section.sh 233 entropy_zeta_heat_kernel "Entropy Zeta Heat Kernel"
bash scripts/add_section.sh 234 trace_diagonalization_schemes "Trace Diagonalization Schemes"
bash scripts/add_section.sh 235 entropy_stratification_metrics "Entropy Stratification Metrics"
bash scripts/add_section.sh 236 rigidity_and_deformation_bounds "Rigidity and Deformation Bounds"
bash scripts/add_section.sh 237 categorical_entropy_actions "Categorical Entropy Actions"
bash scripts/add_section.sh 238 examples_fontaine_entropy "Examples: Fontaine Entropy"
bash scripts/add_section.sh 239 examples_automorphic_entropy "Examples: Automorphic Entropy"
bash scripts/add_section.sh 240 synthesis_future_directions "Synthesis and Future Directions"

say "Syncing auto input lists..."
bash scripts/sync_inputs.sh

# ---- build scripts/dev.sh (portable) ----
if [[ ! -x scripts/dev.sh ]]; then
  cat > scripts/dev.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
cd "$ROOT"

mkdir -p build/amsart build/beamer

echo "[BUILD] AMSArt..."
( cd amsart && pdflatex -interaction=nonstopmode -halt-on-error -output-directory=../build/amsart main.tex >/dev/null )
( cd amsart && pdflatex -interaction=nonstopmode -halt-on-error -output-directory=../build/amsart main.tex >/dev/null )

echo "[BUILD] Beamer..."
( cd beamer && pdflatex -interaction=nonstopmode -halt-on-error -output-directory=../build/beamer slides.tex >/dev/null )
( cd beamer && pdflatex -interaction=nonstopmode -halt-on-error -output-directory=../build/beamer slides.tex >/dev/null )

echo "[OK] Outputs:"
echo "  build/amsart/main.pdf"
echo "  build/beamer/slides.pdf"
EOF
  chmod +x scripts/dev.sh
fi

say "Building PDFs..."
bash scripts/dev.sh

say "Git status:"
git status --porcelain=v1 || true

echo ""
echo "[NEXT] Continue by generating more sections (example 241–260):"
echo "  bash scripts/add_section.sh 241 entropy_wall_residues \"Entropy Wall Residues\""
echo "  bash scripts/sync_inputs.sh"
echo "  bash scripts/dev.sh"
