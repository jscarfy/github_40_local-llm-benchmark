#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat >&2 <<'USAGE'
Usage:
  scripts/new_section.sh --append <N> <slug>

Behavior:
  Creates:
    tex/amsart/sections/section_<N>_<slug>.tex
    tex/beamer/frames/frame_<N>_overview.tex
  Does NOT overwrite existing files unless you pass --force.

Options:
  --append   required (kept for compatibility with your workflow)
  --force    overwrite existing files
USAGE
  exit 2
}

APPEND=""
FORCE="0"

if [ $# -lt 3 ]; then usage; fi

while [ $# -gt 0 ]; do
  case "$1" in
    --append) APPEND="1"; shift ;;
    --force) FORCE="1"; shift ;;
    *) break ;;
  esac
done

if [ -z "${APPEND}" ]; then usage; fi
if [ $# -ne 2 ]; then usage; fi

N="$1"
SLUG="$2"

mkdir -p tex/amsart/sections tex/beamer/frames

AMSART="tex/amsart/sections/section_${N}_${SLUG}.tex"
FRAME="tex/beamer/frames/frame_${N}_overview.tex"

if [ -e "${AMSART}" ] && [ "${FORCE}" != "1" ]; then
  echo "SKIP: exists: ${AMSART}" >&2
else
  cat > "${AMSART}" <<EOF2
\\section{${SLUG//_/ }}\\label{sec:${SLUG//_/-}-${N}}

\\subsection{Placeholder}
This section is a placeholder generated by \\texttt{scripts/new_section.sh}. Replace with full content.

\\begin{definition}[Placeholder]
A placeholder definition for ${SLUG//_/ }.
\\end{definition}

\\begin{construction}[Placeholder construction]
A placeholder construction for ${SLUG//_/ }.
\\end{construction}

\\begin{highlightedSyntaxPhenomenon}[Placeholder phenomenon]
{\\ }
A placeholder highlighted syntax phenomenon for ${SLUG//_/ }.
\\end{highlightedSyntaxPhenomenon}
EOF2
fi

if [ -e "${FRAME}" ] && [ "${FORCE}" != "1" ]; then
  echo "SKIP: exists: ${FRAME}" >&2
else
  cat > "${FRAME}" <<EOF3
\\begin{frame}{Section ${N}: ${SLUG//_/ }}
\\begin{itemize}
  \\item Placeholder bullet 1.
  \\item Placeholder bullet 2.
  \\item Placeholder bullet 3.
\\end{itemize}
\\end{frame}
EOF3
fi

echo "OK: ${AMSART}"
echo "OK: ${FRAME}"
